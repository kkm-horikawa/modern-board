name: Claude Action Dispatcher

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  dispatch-actions:
    # 以下の条件で起動:
    # 1. コメント投稿者がgithub-actions[bot]またはClaude Code
    # 2. コメント内容にアクション関連のキーワードが含まれる
    # 3. @claudeメンションがまだ含まれていない（無限ループ防止）
    if: |
      (github.event.comment.user.login == 'github-actions[bot]' ||
       contains(github.event.comment.body, 'Generated with [Claude Code]')) &&
      !contains(github.event.comment.body, '@claude') &&
      (contains(github.event.comment.body, 'アクション') ||
       contains(github.event.comment.body, 'TODO') ||
       contains(github.event.comment.body, '次のステップ') ||
       contains(github.event.comment.body, '推奨') ||
       contains(github.event.comment.body, 'Issue') ||
       contains(github.event.comment.body, 'PR'))

    runs-on: ubuntu-latest

    steps:
      - name: Get Issue Number
        id: get_issue
        run: |
          # Issue番号を取得
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            ISSUE_NUMBER="${{ github.event.pull_request.number }}"
          fi

          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
          echo "✅ Issue #$ISSUE_NUMBER を処理します"

      - name: Dispatch to Claude
        run: |
          ISSUE_NUMBER=${{ env.ISSUE_NUMBER }}

          # Claudeに上記コメントを読んで必要なアクションを実行するよう指示
          cat > /tmp/claude-instruction.md << 'ENDOFFILE'
          @claude

          上記のコメントを読んで、以下の対応が必要か判断し、必要であれば実行してください：

          - **新規Issue作成**: バグ報告、改善提案、タスク追加など
          - **既存Issue整理**: ラベル更新、優先度変更、重複クローズなど
          - **PR関連**: マージ、レビュー、Draft→Readyへの変更など
          - **実装確認**: コード品質、テストカバレッジ、ドキュメント更新など
          - **マイルストーン管理**: 進捗確認、完了処理、次マイルストーン準備など

          判断基準：
          - 明確なアクション項目が記載されている場合は実行
          - 曖昧な場合は質問またはスキップ
          - 完了後は簡潔にサマリーを報告
          ENDOFFILE

          # PATアカウントを使ってClaudeをメンション
          gh issue comment $ISSUE_NUMBER --body-file /tmp/claude-instruction.md

          echo "✅ Issue #$ISSUE_NUMBER にClaude向けの指示を投稿しました"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
