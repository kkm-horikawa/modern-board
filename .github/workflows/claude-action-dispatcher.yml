name: Claude Action Dispatcher

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  dispatch-actions:
    # ä»¥ä¸‹ã®æ¡ä»¶ã§èµ·å‹•:
    # 1. ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿è€…ãŒgithub-actions[bot]ã¾ãŸã¯Claude Code
    # 2. ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹
    # 3. @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã¾ã å«ã¾ã‚Œã¦ã„ãªã„ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
    if: |
      (github.event.comment.user.login == 'github-actions[bot]' ||
       contains(github.event.comment.body, 'Generated with [Claude Code]')) &&
      !contains(github.event.comment.body, '@claude') &&
      (contains(github.event.comment.body, 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³') ||
       contains(github.event.comment.body, 'TODO') ||
       contains(github.event.comment.body, 'æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—') ||
       contains(github.event.comment.body, 'æ¨å¥¨') ||
       contains(github.event.comment.body, 'Issue') ||
       contains(github.event.comment.body, 'PR'))

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Parse comment for actions
        id: parse
        run: |
          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’å–å¾—
          COMMENT_BODY='${{ github.event.comment.body }}'

          # Issueç•ªå·ã‚’å–å¾—
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            ISSUE_NUMBER="${{ github.event.pull_request.number }}"
          fi

          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV

          # parse_actions.pyã‚’å®Ÿè¡Œ
          RESULT=$(ISSUE_NUMBER=$ISSUE_NUMBER python3 .github/scripts/parse_actions.py "$COMMENT_BODY")

          echo "Parse result:"
          echo "$RESULT"

          # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæŠ½å‡ºã§ããŸã‹ãƒã‚§ãƒƒã‚¯
          HAS_ACTIONS=$(echo "$RESULT" | jq -r '.has_actions')
          echo "has_actions=$HAS_ACTIONS" >> $GITHUB_OUTPUT

          if [ "$HAS_ACTIONS" = "true" ]; then
            # Claudeå‘ã‘ã®æŒ‡ç¤ºæ–‡ã‚’æŠ½å‡º
            INSTRUCTIONS=$(echo "$RESULT" | jq -r '.instructions')

            # æŒ‡ç¤ºæ–‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
            echo "$INSTRUCTIONS" > /tmp/claude-instructions.md

            echo "âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
            echo "ğŸ“ æŒ‡ç¤ºæ–‡:"
            cat /tmp/claude-instructions.md
          else
            echo "â„¹ï¸ å®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Dispatch to Claude
        if: steps.parse.outputs.has_actions == 'true'
        run: |
          ISSUE_NUMBER=${{ env.ISSUE_NUMBER }}

          # PATã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ã£ã¦Claudeã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
          gh issue comment $ISSUE_NUMBER --body-file /tmp/claude-instructions.md

          echo "âœ… Issue #$ISSUE_NUMBER ã«Claudeå‘ã‘ã®æŒ‡ç¤ºã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Log dispatch result
        if: always()
        run: |
          if [ "${{ steps.parse.outputs.has_actions }}" = "true" ]; then
            echo "âœ… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒå®Œäº†"
            echo "   - Issue #${{ env.ISSUE_NUMBER }}"
            echo "   - Claudeã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè¡ŒãŒé–‹å§‹ã•ã‚Œã¾ã™"
          else
            echo "â„¹ï¸ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŸã‚ã€ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
          fi
