name: Claude Project Manager

on:
  schedule:
    # 毎日 9:00, 15:00, 21:00 (JST = UTC+9 なので 0:00, 6:00, 12:00 UTC)
    - cron: '0 0,6,12 * * *'
  workflow_dispatch:  # 手動トリガーも可能

jobs:
  create-management-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Create project management issue
        run: |
          # 現在の日時を取得
          DATE=$(date -u +%Y-%m-%d-%H%M)

          # テンプレートを読み込んでIssueを作成
          gh issue create \
            --title "DAILY-${DATE}: プロジェクト管理とタスク優先順位付け" \
            --body-file .github/templates/project-management-issue.md \
            --label "project-management,automated,priority:critical" \
            --milestone "マイルストーン0: 自動化基盤構築"

          echo "✅ プロジェクト管理Issueを作成しました: DAILY-${DATE}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Mention Claude for analysis
        if: success()
        run: |
          # 作成したIssueの番号を取得
          ISSUE_NUMBER=$(gh issue list --label "project-management" --limit 1 --json number --jq '.[0].number')

          # Claudeをメンションして分析を依頼
          gh issue comment $ISSUE_NUMBER --body "@claude

プロジェクト管理タスクを実行してください。

## 実行内容
以下の情報を分析し、詳細なレポートをこのIssueにコメントで投稿してください：

1. **オープンなPRの確認**
   - レビューが必要なPR
   - CI/CDの状態
   - マージ可能かどうか

2. **Issueの優先順位分析**
   - バグ、ブロッカーの有無
   - マイルストーン進捗
   - 次に着手すべきIssue

3. **推奨アクション**
   - 最優先で対応すべきこと
   - 次のステップの提案

**重要**: Issue作成やPR作成は不要です。分析と推奨アクションの提示のみお願いします。"

          echo "✅ Issue #$ISSUE_NUMBER にClaudeをメンションしました"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
