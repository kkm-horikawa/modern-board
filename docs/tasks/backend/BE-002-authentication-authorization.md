# BE-002: 認証・認可システムの実装（親タスク）

## 概要
匿名掲示板における認証・認可システムを実装する。ユーザーセッションベースの一時的な識別と、管理機能用の本格的な認証を両立させる。

**注**: このタスクは複数の独立した機能を含むため、以下のサブタスクに分割されています。

## サブタスク
- **BE-002-1**: セッションベース認証とミドルウェア
- **BE-002-2**: CORS設定とセキュリティ
- **BE-002-3**: 管理者権限とパーミッション（オプション）

## 優先度
**High** - コア機能に必要

## 難易度
**Hard** (全体として)

## 前提条件
- [x] UserSessionモデルが実装済み
- [x] DjangoとDRFがセットアップ済み
- [ ] 認証要件が明確化されている

## 実装内容

### 1. セッションベース認証の実装
- [ ] ミドルウェアの作成: 匿名ユーザーに一時セッションを自動付与
- [ ] セッションIDのCookie管理
- [ ] セッション有効期限の設定（デフォルト30日）
- [ ] セッションのクリーンアップバッチ処理

### 2. 一時名（匿名ハンドルネーム）システム
- [ ] スレッドごとに異なる一時名を生成するロジック
- [ ] 一時名の形式定義（例: "名無しさん@ランダムID"）
- [ ] 一時名の永続化（Postモデルのauthor_nameフィールド）
- [ ] 同一スレッド内での同一セッション識別（ユーザビリティ向上）

### 3. 管理者認証（オプション）
- [ ] Django Admin用のユーザーモデル拡張（必要に応じて）
- [ ] スタッフユーザーのみアクセス可能なエンドポイントの保護
- [ ] カテゴリ・タグ管理機能の権限設定
- [ ] スレッドロック・削除権限の設定

### 4. CORS設定
- [ ] `django-cors-headers`の設定（既にインストール済み）
- [ ] 許可するオリジンの設定（開発/本番環境別）
- [ ] 許可するHTTPメソッドの設定
- [ ] Credentialsの許可設定

### 5. セキュリティ設定
- [ ] CSRF設定（DRF SessionAuthentication利用時）
- [ ] レート制限の実装（django-ratelimitまたはDRF throttling）
- [ ] IPアドレスベースの投稿制限（スパム対策）
- [ ] セッションハイジャック対策

### 6. テスト
- [ ] セッション自動生成のテスト
- [ ] 一時名生成のテスト
- [ ] 権限チェックのテスト
- [ ] CORS動作のテスト

## 受け入れ基準
- [ ] 匿名ユーザーが投稿可能（セッションベース）
- [ ] 同一スレッド内で同一セッションの投稿が識別可能
- [ ] 管理者のみアクセス可能なエンドポイントが保護されている
- [ ] CORS設定が正しく動作する
- [ ] セキュリティテストをパスする
- [ ] セッションのクリーンアップが正常に動作する

## 関連タスク
- BE-001: API統合テスト（認証後のエンドポイントテストに必要）
- BE-003: スパム対策・レート制限
- FE-001: 認証フロー実装

## 技術的決定事項（要確認）
- [ ] 完全匿名 vs 一時セッション識別のどちらを採用するか
- [ ] 管理者認証にDjango標準認証を使うか、別のシステムを使うか
- [ ] トリップ機能（本人証明）を実装するか

## 参考
- Django Authentication: https://docs.djangoproject.com/en/5.2/topics/auth/
- DRF Authentication: https://www.django-rest-framework.org/api-guide/authentication/
- django-cors-headers: https://github.com/adamchainz/django-cors-headers
