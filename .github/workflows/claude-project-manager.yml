name: Claude Project Manager

on:
  schedule:
    # 30åˆ†ãŠãã«å®Ÿè¡Œ
    - cron: '*/30 * * * *'
  workflow_dispatch:  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã‚‚å¯èƒ½

permissions:
  contents: read
  issues: write

jobs:
  create-management-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Create project management issue
        run: |
          # ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
          DATE=$(date -u +%Y-%m-%d-%H%M)

          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§Issueã‚’ä½œæˆã—ã€URLã‚’å–å¾—
          ISSUE_URL=$(gh issue create \
            --title "DAILY-${DATE}: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã¨ã‚¿ã‚¹ã‚¯å„ªå…ˆé †ä½ä»˜ã‘" \
            --body-file .github/templates/project-management-issue.md \
            --label "project-management,automated,priority:critical" \
            --milestone "ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³0: è‡ªå‹•åŒ–åŸºç›¤æ§‹ç¯‰" \
            --assignee @me)

          # URLã‹ã‚‰Issueç•ªå·ã‚’æŠ½å‡º
          ISSUE_NUMBER=$(echo $ISSUE_URL | sed 's|.*/||')

          echo "âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†Issueã‚’ä½œæˆã—ã¾ã—ãŸ: Issue #${ISSUE_NUMBER}"

          # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Mention Claude for analysis
        if: success()
        run: |
          # å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ä¿å­˜ã—ãŸIssueç•ªå·ã‚’ä½¿ç”¨
          ISSUE_NUMBER=${{ env.ISSUE_NUMBER }}

          # Claudeã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦è‡ªå‹•ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚’é–‹å§‹
          cat > /tmp/claude-mention.md << 'ENDOFFILE'
          @claude

          ã“ã®Issueã®èª¬æ˜Žã«è¨˜è¼‰ã•ã‚ŒãŸ**è‡ªå‹•ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã‚¿ã‚¹ã‚¯**ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’åˆ†æžã—ã€å„ªå…ˆé †ä½ã«åŸºã¥ã„ã¦**å®Ÿéš›ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ**ã—ã¦ãã ã•ã„ï¼š

          ðŸ“Š **åˆ†æžé …ç›®:**
          - ã‚ªãƒ¼ãƒ—ãƒ³ãªPRç¢ºèªã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼
          - Issueå„ªå…ˆé †ä½åˆ†æž
          - ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€²æ—ç¢ºèª
          - CI/CDå¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
          - ã‚¿ã‚¹ã‚¯é€²æ—ç¢ºèª

          ðŸš€ **å®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
          - Issueå®Ÿè£…ï¼ˆæ–°ã—ã„PRä½œæˆï¼‰
          - PRãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆApprove/Request Changesï¼‰
          - æ–°ã—ã„Issueä½œæˆ
          - ãƒžã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å‰²ã‚Šå½“ã¦
          - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒ‰æ›´æ–°
          - ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³æŠ•ç¨¿

          å„ªå…ˆé †ä½: Critical â†’ High â†’ Medium â†’ Low ã®é †ã§åˆ¤æ–­ã—ã€å°‘ãªãã¨ã‚‚1ã¤ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

          å®Œäº†å¾Œã€å®Ÿè¡Œå†…å®¹ã‚’ã“ã®Issueã«å ±å‘Šã—ã€è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚
          ENDOFFILE

          gh issue comment $ISSUE_NUMBER --body-file /tmp/claude-mention.md

          echo "âœ… Issue #$ISSUE_NUMBER ã«Claudeã‚’ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¾ã—ãŸ"
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Notify Slack on Success
        if: success()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âœ… *Claude Project Manager - å®Ÿè¡ŒæˆåŠŸ*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âœ… *Claude Project Manager - å®Ÿè¡ŒæˆåŠŸ*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒªãƒã‚¸ãƒˆãƒª:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Issueä½œæˆ:*\n#${{ env.ISSUE_NUMBER }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*å®Ÿè¡ŒID:*\n${{ github.run_id }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Issue #${{ env.ISSUE_NUMBER }}ã‚’ç¢ºèª"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/issues/${{ env.ISSUE_NUMBER }}"
                    }
                  ]
                }
              ]
            }'

      - name: Notify Slack on Failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âŒ *Claude Project Manager - å®Ÿè¡Œå¤±æ•—*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âŒ *Claude Project Manager - å®Ÿè¡Œå¤±æ•—*"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒªãƒã‚¸ãƒˆãƒª:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*å®Ÿè¡ŒID:*\n${{ github.run_id }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒ­ã‚°ã‚’ç¢ºèª"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }'
