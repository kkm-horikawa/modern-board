name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Optional: Give a custom prompt to Claude. If this is not specified, Claude will perform the instructions specified in the comment that tagged it.
          # prompt: 'Update the pull request description to include a summary of changes.'

          # Allow gh commands for full automation
          claude_args: '--allowed-tools "Bash(gh:*)"'
        env:
          # Use PAT_TOKEN for gh commands to allow triggering other workflows
          # (CLAUDE_CODE_OAUTH_TOKEN doesn't trigger workflows to prevent infinite loops)
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Get Claude's Response
        if: always()
        id: get_response
        run: |
          # Issueの最新コメントを取得（Claudeが書いたもの）
          if [ "${{ github.event_name }}" = "issue_comment" ] || [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"

            # 最新のコメントを取得（最大3000文字）
            COMMENT=$(gh issue view $ISSUE_NUMBER --comments --json comments --jq '.comments[-1].body' | head -c 3000)

            # 改行とダブルクォートをエスケープ
            COMMENT_ESCAPED=$(echo "$COMMENT" | jq -Rs .)

            echo "comment=$COMMENT_ESCAPED" >> $GITHUB_OUTPUT
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify Slack with Claude's Response
        if: always() && steps.get_response.outputs.comment != ''
        run: |
          STATUS="${{ job.status }}"
          STATUS_ICON="${{ job.status == 'success' && '✅' || '❌' }}"

          # コメント内容を取得
          COMMENT_TEXT=${{ steps.get_response.outputs.comment }}

          # Slackペイロードを構築
          cat > /tmp/slack-payload.json << ENDOFFILE
          {
            "text": "${STATUS_ICON} Claude実行完了 - Issue #${{ steps.get_response.outputs.issue_number }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "${STATUS_ICON} *Claude実行完了*"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*リポジトリ:*\n${{ github.repository }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Issue:*\n#${{ steps.get_response.outputs.issue_number }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*ステータス:*\n$STATUS"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*実行内容:*\n${COMMENT_TEXT}"
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "Issue #${{ steps.get_response.outputs.issue_number }}を確認"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/issues/${{ steps.get_response.outputs.issue_number }}"
                  }
                ]
              }
            ]
          }
          ENDOFFILE

          # Slackに送信
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d @/tmp/slack-payload.json
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

